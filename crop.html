<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resim KÄ±rpma UygulamasÄ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .upload-section {
            margin-bottom: 20px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
        }
        
        .upload-section label {
            display: inline-block;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .upload-section label:hover {
            background: #0056b3;
        }
        
        #avatar {
            display: none;
        }
        
        .crop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow: auto;
        }
        
        .crop-content {
            position: relative;
            margin: 20px auto;
            max-width: 90%;
            max-height: 90%;
            text-align: center;
        }
        
        .crop-container {
            position: relative;
            display: inline-block;
            margin: 20px;
        }
        
        .crop-image {
            max-width: 100%;
            max-height: 70vh;
            display: block;
            margin: 0 auto;
            border: 1px solid #ddd;
        }
        
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            cursor: crosshair;
        }
        
        .crop-selection {
            position: absolute;
            border: 2px solid #007bff;
            background: transparent;
            cursor: move;
            min-width: 50px;
            min-height: 50px;
        }
        
        .crop-selection::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px dashed white;
        }
        
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #007bff;
            border: 2px solid white;
            border-radius: 50%;
        }
        
        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        
        .crop-buttons {
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .preview-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        #result {
            max-width: 200px;
            max-height: 200px;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: none;
            margin: 10px 0;
        }
        
        .coords-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .coord-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .coord-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Resim KÄ±rpma UygulamasÄ±</h2>
        
        <div class="upload-section">
            <label for="avatar">
                ðŸ“· Resim SeÃ§
                <input type="file" id="avatar" accept="image/*">
            </label>
            <p>KÄ±rpmak istediÄŸiniz resmi seÃ§in (JPG, PNG)</p>
        </div>
        
        <div class="preview-section">
            <h3>KÄ±rpÄ±lmÄ±ÅŸ Resim Ã–nizlemesi</h3>
            <img id="result" alt="KÄ±rpÄ±lmÄ±ÅŸ resim Ã¶nizlemesi">
            
            <div class="coords-info">
                <div>
                    <label class="coord-label">GeniÅŸlik (px)</label>
                    <input type="number" id="avatar_width" class="coord-input" readonly>
                </div>
                <div>
                    <label class="coord-label">YÃ¼kseklik (px)</label>
                    <input type="number" id="avatar_height" class="coord-input" readonly>
                </div>
                <div>
                    <label class="coord-label">X KoordinatÄ±</label>
                    <input type="number" id="avatar_x" class="coord-input" readonly>
                </div>
                <div>
                    <label class="coord-label">Y KoordinatÄ±</label>
                    <input type="number" id="avatar_y" class="coord-input" readonly>
                </div>
            </div>
        </div>
    </div>
    
    <!-- KÄ±rpma Modal -->
    <div class="crop-modal" id="cropModal">
        <div class="crop-content">
            <div class="crop-container">
                <img class="crop-image" id="cropImage" alt="KÄ±rpÄ±lacak resim">
                <div class="crop-overlay" id="cropOverlay">
                    <div class="crop-selection" id="cropSelection">
                        <div class="resize-handle nw"></div>
                        <div class="resize-handle ne"></div>
                        <div class="resize-handle sw"></div>
                        <div class="resize-handle se"></div>
                    </div>
                </div>
            </div>
            <div class="crop-buttons">
                <button class="btn btn-primary" id="cropBtn">KÄ±rp</button>
                <button class="btn btn-secondary" id="cancelBtn">Ä°ptal</button>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let currentImage = null;
            let isDragging = false;
            let isResizing = false;
            let dragStart = { x: 0, y: 0 };
            let selectionStart = { x: 0, y: 0, width: 0, height: 0 };
            let resizeHandle = null;
            
            // Dosya seÃ§ildiÄŸinde modal aÃ§
            $('#avatar').on('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentImage = e.target.result;
                        const cropImage = $('#cropImage');
                        
                        // Ã–nce resmi yÃ¼kle, sonra modal'Ä± aÃ§
                        cropImage.attr('src', currentImage);
                        
                        // Resim tam yÃ¼klendiÄŸinde modal'Ä± aÃ§ ve seÃ§im alanÄ± oluÅŸtur
                        cropImage.on('load', function() {
                            $('#cropModal').fadeIn();
                            setTimeout(initializeCropSelection, 200);
                        });
                        
                        // EÄŸer resim cache'den gelirse load eventi Ã§alÄ±ÅŸmayabilir
                        if (cropImage[0].complete) {
                            $('#cropModal').fadeIn();
                            setTimeout(initializeCropSelection, 200);
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('LÃ¼tfen geÃ§erli bir resim dosyasÄ± seÃ§in (JPG, PNG)');
                }
            });
            
            // VarsayÄ±lan kÄ±rpma alanÄ±nÄ± baÅŸlat
            function initializeCropSelection() {
                console.log('KÄ±rpma alanÄ± baÅŸlatÄ±lÄ±yor...');
                const img = $('#cropImage')[0];
                
                if (!img || !img.clientWidth || !img.clientHeight) {
                    console.log('Resim henÃ¼z yÃ¼klenmedi, tekrar deneniyor...');
                    setTimeout(initializeCropSelection, 100);
                    return;
                }
                
                console.log('Resim boyutlarÄ±:', img.clientWidth, 'x', img.clientHeight);
                
                const imgRect = img.getBoundingClientRect();
                const overlay = $('#cropOverlay');
                const overlayRect = overlay[0].getBoundingClientRect();
                
                // GÃ¶reli konumlarÄ± hesapla
                const offsetX = imgRect.left - overlayRect.left;
                const offsetY = imgRect.top - overlayRect.top;
                
                // Resmin merkezinde kare alan oluÅŸtur
                const size = Math.min(img.clientWidth, img.clientHeight) * 0.5;
                const x = offsetX + (img.clientWidth - size) / 2;
                const y = offsetY + (img.clientHeight - size) / 2;
                
                console.log('SeÃ§im alanÄ±:', x, y, size);
                
                updateCropSelection(x, y, size, size);
                updateOverlayMask();
            }
            
            // KÄ±rpma seÃ§imini gÃ¼ncelle
            function updateCropSelection(x, y, width, height) {
                const selection = $('#cropSelection');
                selection.css({
                    left: x + 'px',
                    top: y + 'px',
                    width: width + 'px',
                    height: height + 'px'
                });
            }
            
            // Overlay maskÄ±nÄ± gÃ¼ncelle
            function updateOverlayMask() {
                const selection = $('#cropSelection');
                const overlay = $('#cropOverlay');
                const pos = selection.position();
                const width = selection.outerWidth();
                const height = selection.outerHeight();
                
                // CSS ile masklama efekti
                const maskValue = `
                    polygon(
                        0% 0%, 
                        0% 100%, 
                        ${pos.left}px 100%, 
                        ${pos.left}px ${pos.top}px, 
                        ${pos.left + width}px ${pos.top}px, 
                        ${pos.left + width}px ${pos.top + height}px, 
                        ${pos.left}px ${pos.top + height}px, 
                        ${pos.left}px 100%, 
                        100% 100%, 
                        100% 0%
                    )
                `;
                
                overlay.css({
                    'clip-path': maskValue,
                    '-webkit-clip-path': maskValue
                });
            }
            
            // Mouse olaylarÄ± - Overlay Ã¼zerinde yeni seÃ§im baÅŸlatma
            $('#cropOverlay').on('mousedown', function(e) {
                if ($(e.target).hasClass('resize-handle')) {
                    startResize(e);
                } else if ($(e.target).hasClass('crop-selection')) {
                    startDrag(e);
                } else {
                    startNewSelection(e);
                }
                e.preventDefault();
            });
            
            // Yeni seÃ§im baÅŸlat
            function startNewSelection(e) {
                const overlay = $('#cropOverlay');
                const offset = overlay.offset();
                const startX = e.pageX - offset.left;
                const startY = e.pageY - offset.top;
                
                isDragging = true;
                selectionStart = { x: startX, y: startY, width: 0, height: 0 };
                
                updateCropSelection(startX, startY, 0, 0);
            }
            
            // SÃ¼rÃ¼kleme baÅŸlat
            function startDrag(e) {
                isDragging = true;
                const selection = $('#cropSelection');
                const pos = selection.position();
                dragStart = {
                    x: e.pageX - pos.left,
                    y: e.pageY - pos.top
                };
            }
            
            // Yeniden boyutlandÄ±rma baÅŸlat
            function startResize(e) {
                isResizing = true;
                resizeHandle = $(e.target).attr('class').split(' ')[1];
                e.stopPropagation();
            }
            
            // Mouse hareket
            $(document).on('mousemove', function(e) {
                if (isDragging && !isResizing) {
                    if (selectionStart.width === 0) {
                        // Yeni seÃ§im oluÅŸtur
                        const overlay = $('#cropOverlay');
                        const offset = overlay.offset();
                        const currentX = e.pageX - offset.left;
                        const currentY = e.pageY - offset.top;
                        
                        const width = Math.abs(currentX - selectionStart.x);
                        const height = Math.abs(currentY - selectionStart.y);
                        const size = Math.min(width, height); // Kare yapmak iÃ§in
                        
                        const x = currentX > selectionStart.x ? selectionStart.x : selectionStart.x - size;
                        const y = currentY > selectionStart.y ? selectionStart.y : selectionStart.y - size;
                        
                        updateCropSelection(x, y, size, size);
                    } else {
                        // Mevcut seÃ§imi sÃ¼rÃ¼kle
                        const overlay = $('#cropOverlay');
                        const offset = overlay.offset();
                        const newX = e.pageX - offset.left - dragStart.x;
                        const newY = e.pageY - offset.top - dragStart.y;
                        
                        const selection = $('#cropSelection');
                        const width = selection.outerWidth();
                        const height = selection.outerHeight();
                        
                        // SÄ±nÄ±rlarÄ± kontrol et
                        const img = $('#cropImage')[0];
                        const imgRect = img.getBoundingClientRect();
                        const overlayRect = overlay[0].getBoundingClientRect();
                        const imgOffsetX = imgRect.left - overlayRect.left;
                        const imgOffsetY = imgRect.top - overlayRect.top;
                        
                        const maxX = imgOffsetX + img.clientWidth - width;
                        const maxY = imgOffsetY + img.clientHeight - height;
                        
                        const boundedX = Math.max(imgOffsetX, Math.min(maxX, newX));
                        const boundedY = Math.max(imgOffsetY, Math.min(maxY, newY));
                        
                        updateCropSelection(boundedX, boundedY, width, height);
                    }
                    updateOverlayMask();
                } else if (isResizing) {
                    handleResize(e);
                }
            });
            
            // Yeniden boyutlandÄ±rma iÅŸle
            function handleResize(e) {
                const overlay = $('#cropOverlay');
                const offset = overlay.offset();
                const mouseX = e.pageX - offset.left;
                const mouseY = e.pageY - offset.top;
                const selection = $('#cropSelection');
                const pos = selection.position();
                const currentWidth = selection.outerWidth();
                const currentHeight = selection.outerHeight();
                
                let newX = pos.left;
                let newY = pos.top;
                let newSize = currentWidth;
                
                // Resim sÄ±nÄ±rlarÄ±
                const img = $('#cropImage')[0];
                const imgRect = img.getBoundingClientRect();
                const overlayRect = overlay[0].getBoundingClientRect();
                const imgOffsetX = imgRect.left - overlayRect.left;
                const imgOffsetY = imgRect.top - overlayRect.top;
                const imgMaxX = imgOffsetX + img.clientWidth;
                const imgMaxY = imgOffsetY + img.clientHeight;
                
                switch(resizeHandle) {
                    case 'se':
                        newSize = Math.min(
                            Math.abs(mouseX - pos.left),
                            Math.abs(mouseY - pos.top),
                            imgMaxX - pos.left,
                            imgMaxY - pos.top
                        );
                        break;
                    case 'sw':
                        newSize = Math.min(
                            Math.abs(pos.left + currentWidth - mouseX),
                            Math.abs(mouseY - pos.top),
                            pos.left + currentWidth - imgOffsetX,
                            imgMaxY - pos.top
                        );
                        newX = pos.left + currentWidth - newSize;
                        break;
                    case 'ne':
                        newSize = Math.min(
                            Math.abs(mouseX - pos.left),
                            Math.abs(pos.top + currentHeight - mouseY),
                            imgMaxX - pos.left,
                            pos.top + currentHeight - imgOffsetY
                        );
                        newY = pos.top + currentHeight - newSize;
                        break;
                    case 'nw':
                        newSize = Math.min(
                            Math.abs(pos.left + currentWidth - mouseX),
                            Math.abs(pos.top + currentHeight - mouseY),
                            pos.left + currentWidth - imgOffsetX,
                            pos.top + currentHeight - imgOffsetY
                        );
                        newX = pos.left + currentWidth - newSize;
                        newY = pos.top + currentHeight - newSize;
                        break;
                }
                
                newSize = Math.max(50, newSize); // Minimum boyut
                updateCropSelection(newX, newY, newSize, newSize);
                updateOverlayMask();
            }
            
            // Mouse bÄ±rak
            $(document).on('mouseup', function() {
                isDragging = false;
                isResizing = false;
                resizeHandle = null;
                selectionStart = { x: 0, y: 0, width: 0, height: 0 };
            });
            
            // KÄ±rpma iÅŸlemi
            $('#cropBtn').on('click', function() {
                cropImage();
            });
            
            // Ä°ptal
            $('#cancelBtn').on('click', function() {
                $('#cropModal').fadeOut();
                $('#avatar').val(''); // Input'u temizle
            });
            
            // Resmi kÄ±rp
            function cropImage() {
                const img = $('#cropImage')[0];
                const selection = $('#cropSelection');
                const pos = selection.position();
                const selectionWidth = selection.outerWidth();
                const selectionHeight = selection.outerHeight();
                
                // Resim boyutlarÄ±
                const imgRect = img.getBoundingClientRect();
                const overlay = $('#cropOverlay');
                const overlayRect = overlay[0].getBoundingClientRect();
                const imgOffsetX = imgRect.left - overlayRect.left;
                const imgOffsetY = imgRect.top - overlayRect.top;
                
                // Orijinal resim boyutlarÄ±na gÃ¶re kÄ±rpma koordinatlarÄ±
                const scaleX = img.naturalWidth / img.clientWidth;
                const scaleY = img.naturalHeight / img.clientHeight;
                
                const cropX = Math.round((pos.left - imgOffsetX) * scaleX);
                const cropY = Math.round((pos.top - imgOffsetY) * scaleY);
                const cropWidth = Math.round(selectionWidth * scaleX);
                const cropHeight = Math.round(selectionHeight * scaleY);
                
                // Canvas ile kÄ±rpma
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = cropWidth;
                canvas.height = cropHeight;
                
                ctx.drawImage(img, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                
                // Sonucu gÃ¶ster
                const croppedDataUrl = canvas.toDataURL('image/png');
                $('#result').attr('src', croppedDataUrl).show();
                
                // KoordinatlarÄ± gÃ¼ncelle
                $('#avatar_x').val(cropX);
                $('#avatar_y').val(cropY);
                $('#avatar_width').val(cropWidth);
                $('#avatar_height').val(cropHeight);
                
                // Modal'Ä± kapat
                $('#cropModal').fadeOut();
                
                console.log('KÄ±rpma koordinatlarÄ±:', {
                    x: cropX,
                    y: cropY,
                    width: cropWidth,
                    height: cropHeight
                });
            }
            
            // Modal dÄ±ÅŸÄ±na tÄ±klama
            $('#cropModal').on('click', function(e) {
                if (e.target === this) {
                    $('#cancelBtn').click();
                }
            });
        });
    </script>
</body>
</html>
